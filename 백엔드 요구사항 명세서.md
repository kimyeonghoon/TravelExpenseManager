다음은 일본 여행 지출 기록 웹 프로그램(React 프론트엔드) 요구사항 명세서를 기반으로 한 **FastAPI 백엔드 요구사항 명세서**이다.

***

## 1. 개요
- 일본 여행 지출 내역의 등록, 조회, 수정, 논리 삭제 REST API 제공
- 이메일 인증 기반 로그인 및 사용자 권한별 데이터 접근 제어
- 프론트엔드 SPA(React)와의 JSON 기반 API 연동
- 모킹 데이터로 프론트엔드 연동 테스트 진행 가능 상태로 요구

***

## 2. 주요 기능 요구사항

### 2.1 공개 지출 내역 조회
- 모든 사용자/비로그인 사용자 접근 가능
- 논리 삭제된 항목은 출력 제외
- 날짜 기준 오름차순 정렬 지원
- 목록, 페이징, 상세조회 API

### 2.2 인증(이메일 코드 로그인)
- 이메일 제출 시 인증코드 발송 API
    - 인증코드 생성 및 유효기간(5분 등) 부여
    - 단건/비동기 이메일 발송(실메일 또는 로컬 콘솔 로그 전송)
- 인증코드 검증 API
    - 성공 시 액세스 토큰(JWT 또는 세션 토큰) 발급
    - 실패 시 재시도 및 오류 메시지 반환
- 인증된 사용자에 한해 개인 내역 관리 허용
- 토큰 유효성 검증 미들웨어

### 2.3 사용자별 지출 내역 관리
- 본인 지출내역 등록, 조회, 수정, 삭제(논리 삭제) API
- 날짜, 카테고리, 결제방식, 금액, 비고 필드 포함
- "YY-MM-DD HH:MM" 포맷의 datetime 파싱/검증
- 필수값/데이터형 엄격 검증 및 오류 응답
- 입력·수정 데이터 변경 시 인증 요구
- 수정 및 삭제 시 본인 소유 항목만 허용

### 2.4 DB 논리 삭제 및 이력관리
- `is_deleted` 플래그 필드 제공. 삭제처리 시 true로 변경
- 논리삭제 데이터는 목록·조회 API 미출력
- 데이터 생성, 수정, 삭제 시 audit 로그(e.g. 사용자, 시각, 변경내용) 기록(추가기능)

### 2.5 API 및 보안
- HTTPS 환경에서만 서비스(배포 시)
- JWT 등 인증 토큰 HttpOnly/쿠키 혹은 헤더 방식
- 입력값 서버단 검증 및 CSRF/SQLI 등 주요 보안 적용
- API Rate Limit(공개 API에 속도 제한)

### 2.6 확장 및 모듈화
- 사용자/지출내역 도메인 분리 설계(라우터, 모델, CRUD 등 모듈화)
- 환경변수 관리 및 분리(.env)
- 추후 기능 확장(다국어, 이력 상세 등)을 고려한 구조

***

## 3. 데이터베이스 모델 요구사항 예시

### 3.1 User (사용자)
- id (PK)
- email (unique, 인증용)
- nickname
- hashed_password (인증 코드 방식일땐 optional)
- created_at, updated_at

### 3.2 SpendRecord (지출내역)
- id (PK)
- user_id (FK, nullable/공개내역소유자는 null)
- date (datetime, "YY-MM-DD HH:MM")
- category (enum: 숙박, 교통, 식비, 입장료 등)
- payment_method (enum: 신용카드, 현금 등)
- amount (int)
- note (nullable)
- is_deleted (bool)
- created_at, updated_at

### 3.3 VerificationCode
- id (PK)
- email
- code
- expires_at
- is_verified

### 3.4 AuditLog (추가기능)
- id
- user_id
- model
- model_id
- action
- changed_at
- detail

***

## 4. API Endpoint(예시)
- `GET /spends/public` — 전체 공개 지출 내역(비로그인/페이징)
- `POST /auth/request-code` — 이메일 인증코드 요청
- `POST /auth/verify-code` — 이메일/인증번호로 로그인(JWT 반환)
- `GET /spends/me` — 내 지출 내역 조회(인증 필요)
- `POST /spends` — 지출 내역 등록
- `PATCH /spends/{id}` — 지출 내역 수정(인라인 수정)
- `DELETE /spends/{id}` — 논리 삭제
- 그 외: 유저 프로필, 로그아웃, 상태 확인 등(API 명세 별도 작성)

***

## 5. 기술/운영 환경
- FastAPI, SQLAlchemy, Alembic(Migrations)
- PostgreSQL/MySQL/SQLite(개발환경)
- 환경변수 분리, CORS 허용
- Docker/Docker Compose 사용 가능

***

## 6. 품질, 성능, 보안
- 비공개정보/토큰 안전 저장, HttpOnly 쿠키/JWT
- DB, API단 이중 데이터 검증 및 에러 메시지 표준화
- 관리/운영을 위한 로그 기록 및 실시간 모니터링 고려
- 단위/통합테스트 코드 필수(Pytest)
- Production 배포시 HTTPS, Rate Limit, CORS, XSS 방지

***

## 7. 디렉터리 구조 예시

```
/backend
  └── app/
      ├── main.py
      ├── routers/
      ├── models/
      ├── schemas/
      ├── crud/
      ├── services/
      ├── core/
      └── utils/
```

***

## 8. 백엔드 개발 단계별 계획

### 8.1 1단계: 프로젝트 기본 구조 및 환경 설정
- FastAPI 프로젝트 디렉터리 구조 생성 (routers, models, schemas, crud, services, core, utils)
- 환경변수 설정 파일 (.env) 구성
- CORS 설정 및 기본 미들웨어 적용
- SQLAlchemy 기본 설정 및 데이터베이스 연결 구성

### 8.2 2단계: 데이터베이스 모델 설계 및 생성
- User 모델: 사용자 정보 (id, email, nickname, 생성/수정 시간)
- SpendRecord 모델: 지출 내역 (id, user_id, date, category, payment_method, amount, note, is_deleted)
- VerificationCode 모델: 이메일 인증 코드 (id, email, code, expires_at, is_verified)
- AuditLog 모델: 감사 로그 (id, user_id, model, model_id, action, changed_at, detail)
- Alembic 마이그레이션 설정 및 초기 스키마 생성

### 8.3 3단계: 사용자 인증 시스템 구현 (이메일 코드 로그인)
- 인증코드 생성 및 이메일 발송 API (`POST /auth/request-code`)
- 인증코드 검증 및 JWT 토큰 발급 API (`POST /auth/verify-code`)
- JWT 토큰 유효성 검증 미들웨어 구현
- 토큰 기반 사용자 인증 의존성 주입 시스템

### 8.4 4단계: 공개 지출 내역 조회 API 개발
- 비로그인 사용자 접근 가능한 공개 지출 내역 조회 (`GET /spends/public`)
- 논리삭제된 항목 제외 필터링
- 날짜 기준 오름차순 정렬 구현
- 페이징 처리 (limit, offset) 지원

### 8.5 5단계: 사용자별 지출 내역 CRUD API 개발
- 개인 지출내역 조회 API (`GET /spends/me`)
- 지출내역 등록 API (`POST /spends`)
- 지출내역 수정 API (`PATCH /spends/{id}`)
- 지출내역 논리삭제 API (`DELETE /spends/{id}`)
- 소유권 검증 및 권한 관리

### 8.6 6단계: 보안 및 권한 관리 시스템 구현
- JWT 토큰 안전한 관리 (HttpOnly 쿠키 또는 헤더 방식)
- API Rate Limiting 구현
- CSRF 보호 및 SQL Injection 방지
- 사용자별 데이터 접근 권한 검증

### 8.7 7단계: 데이터 검증 및 오류 처리 시스템
- Pydantic 스키마를 통한 입력 데이터 검증
- 날짜 형식 ("YY-MM-DD HH:MM") 파싱 및 검증
- 표준화된 에러 응답 포맷 구현
- 필수값 및 데이터 타입 엄격 검증

### 8.8 8단계: API 테스트 및 문서화
- Pytest를 활용한 단위 테스트 작성
- API 통합 테스트 구현
- FastAPI 자동 생성 OpenAPI 문서화
- API 명세서 작성 및 Swagger UI 설정

### 8.9 9단계: 프론트엔드 연동 테스트
- React 프론트엔드와 API 연동 확인
- 모킹 데이터 제공 및 테스트 환경 구성
- 통합 테스트 수행 및 버그 수정
- 성능 최적화 및 최종 배포 준비

***